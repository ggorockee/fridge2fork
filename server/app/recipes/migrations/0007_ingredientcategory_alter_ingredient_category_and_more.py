# Generated by Django 5.2.7 on 2025-10-03 15:43

import django.db.models.deletion
from django.db import migrations, models


def create_categories_and_migrate_data(apps, schema_editor):
    """ì¹´í…Œê³ ë¦¬ ìƒì„± ë° ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜"""
    IngredientCategory = apps.get_model('recipes', 'IngredientCategory')
    NormalizedIngredient = apps.get_model('recipes', 'NormalizedIngredient')
    Ingredient = apps.get_model('recipes', 'Ingredient')

    # ì •ê·œí™” ì¬ë£Œ ì¹´í…Œê³ ë¦¬ ìƒì„±
    category_map_normalized = {}
    normalized_categories = [
        {'name': 'ìœ¡ë¥˜', 'code': 'meat', 'icon': 'ğŸ¥©', 'display_order': 1},
        {'name': 'ì±„ì†Œë¥˜', 'code': 'vegetable', 'icon': 'ğŸ¥•', 'display_order': 2},
        {'name': 'í•´ì‚°ë¬¼', 'code': 'seafood', 'icon': 'ğŸ¦', 'display_order': 3},
        {'name': 'ì¡°ë¯¸ë£Œ', 'code': 'seasoning', 'icon': 'ğŸ§‚', 'display_order': 4},
        {'name': 'ê³¡ë¬¼', 'code': 'grain', 'icon': 'ğŸŒ¾', 'display_order': 5},
        {'name': 'ìœ ì œí’ˆ', 'code': 'dairy', 'icon': 'ğŸ¥›', 'display_order': 6},
        {'name': 'ê¸°íƒ€', 'code': 'etc', 'icon': 'ğŸ“¦', 'display_order': 7},
    ]

    for cat_data in normalized_categories:
        category, _ = IngredientCategory.objects.get_or_create(
            code=cat_data['code'],
            category_type='normalized',
            defaults={
                'name': cat_data['name'],
                'icon': cat_data['icon'],
                'display_order': cat_data['display_order'],
                'is_active': True,
            }
        )
        category_map_normalized[cat_data['code']] = category

    # ì¬ë£Œ ì¹´í…Œê³ ë¦¬ ìƒì„±
    category_map_ingredient = {}
    ingredient_categories = [
        {'name': 'í•„ìˆ˜ ì¬ë£Œ', 'code': 'essential', 'icon': 'â­', 'display_order': 1},
        {'name': 'ì¡°ë¯¸ë£Œ', 'code': 'seasoning', 'icon': 'ğŸ§‚', 'display_order': 2},
        {'name': 'ì„ íƒ ì¬ë£Œ', 'code': 'optional', 'icon': 'â•', 'display_order': 3},
    ]

    for cat_data in ingredient_categories:
        category, _ = IngredientCategory.objects.get_or_create(
            code=cat_data['code'],
            category_type='ingredient',
            defaults={
                'name': cat_data['name'],
                'icon': cat_data['icon'],
                'display_order': cat_data['display_order'],
                'is_active': True,
            }
        )
        category_map_ingredient[cat_data['code']] = category

    # NormalizedIngredient ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
    for norm_ing in NormalizedIngredient.objects.all():
        old_category = norm_ing.category
        if old_category and old_category in category_map_normalized:
            norm_ing.category_new = category_map_normalized[old_category]
            norm_ing.save()

    # Ingredient ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
    for ing in Ingredient.objects.all():
        old_category = ing.category
        if old_category and old_category in category_map_ingredient:
            ing.category_new = category_map_ingredient[old_category]
            ing.save()


class Migration(migrations.Migration):

    dependencies = [
        ('recipes', '0006_fridge_fridge_user_idx_fridge_fridge_session_idx_and_more'),
    ]

    operations = [
        # 1. IngredientCategory ëª¨ë¸ ìƒì„±
        migrations.CreateModel(
            name='IngredientCategory',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, help_text='ë ˆì½”ë“œê°€ ìƒì„±ëœ ì‹œê°', verbose_name='ìƒì„±ì¼ì‹œ')),
                ('updated_at', models.DateTimeField(auto_now=True, help_text='ë ˆì½”ë“œê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ìˆ˜ì •ëœ ì‹œê°', verbose_name='ìˆ˜ì •ì¼ì‹œ')),
                ('name', models.CharField(help_text='ì˜ˆ: ìœ¡ë¥˜, ì±„ì†Œë¥˜, í•„ìˆ˜ ì¬ë£Œ ë“±', max_length=50, verbose_name='ì¹´í…Œê³ ë¦¬ëª…')),
                ('code', models.CharField(help_text='ì‹œìŠ¤í…œ ë‚´ë¶€ ì½”ë“œ (ì˜ˆ: meat, vegetable)', max_length=50, verbose_name='ì½”ë“œ')),
                ('category_type', models.CharField(choices=[('normalized', 'ì •ê·œí™” ì¬ë£Œ ì¹´í…Œê³ ë¦¬'), ('ingredient', 'ì¬ë£Œ ì¹´í…Œê³ ë¦¬')], default='normalized', help_text='ì •ê·œí™” ì¬ë£Œìš© ë˜ëŠ” ì¬ë£Œìš©', max_length=20, verbose_name='ì¹´í…Œê³ ë¦¬ íƒ€ì…')),
                ('icon', models.CharField(blank=True, help_text='ì´ëª¨ì§€ ë˜ëŠ” ì•„ì´ì½˜ í´ë˜ìŠ¤ (ì˜ˆ: ğŸ¥©, fas fa-meat)', max_length=50, verbose_name='ì•„ì´ì½˜')),
                ('display_order', models.IntegerField(default=0, help_text='ë‚®ì„ìˆ˜ë¡ ë¨¼ì € í‘œì‹œ', verbose_name='í‘œì‹œ ìˆœì„œ')),
                ('is_active', models.BooleanField(default=True, help_text='ë¹„í™œì„±í™” ì‹œ ì„ íƒ ë¶ˆê°€', verbose_name='í™œì„±í™”')),
                ('description', models.TextField(blank=True, help_text='ì¹´í…Œê³ ë¦¬ ì„¤ëª…', verbose_name='ì„¤ëª…')),
            ],
            options={
                'verbose_name': 'ì¬ë£Œ ì¹´í…Œê³ ë¦¬',
                'verbose_name_plural': 'ì¬ë£Œ ì¹´í…Œê³ ë¦¬',
                'ordering': ['category_type', 'display_order', 'name'],
                'indexes': [models.Index(fields=['category_type', 'is_active'], name='category_type_active_idx'), models.Index(fields=['code'], name='category_code_idx')],
                'unique_together': {('code', 'category_type')},
            },
        ),

        # 2. ì„ì‹œ ForeignKey í•„ë“œ ì¶”ê°€
        migrations.AddField(
            model_name='normalizedingredient',
            name='category_new',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='+', to='recipes.ingredientcategory'),
        ),
        migrations.AddField(
            model_name='ingredient',
            name='category_new',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='+', to='recipes.ingredientcategory'),
        ),

        # 3. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
        migrations.RunPython(create_categories_and_migrate_data),

        # 4. ê¸°ì¡´ category í•„ë“œ ì‚­ì œ
        migrations.RemoveField(
            model_name='normalizedingredient',
            name='category',
        ),
        migrations.RemoveField(
            model_name='ingredient',
            name='category',
        ),

        # 5. category_newë¥¼ categoryë¡œ ì´ë¦„ ë³€ê²½
        migrations.RenameField(
            model_name='normalizedingredient',
            old_name='category_new',
            new_name='category',
        ),
        migrations.RenameField(
            model_name='ingredient',
            old_name='category_new',
            new_name='category',
        ),

        # 6. category í•„ë“œ ì†ì„± ì—…ë°ì´íŠ¸
        migrations.AlterField(
            model_name='ingredient',
            name='category',
            field=models.ForeignKey(blank=True, help_text='ì¬ë£Œ ì¹´í…Œê³ ë¦¬ (í•„ìˆ˜/ì¡°ë¯¸ë£Œ/ì„ íƒ)', limit_choices_to={'category_type': 'ingredient', 'is_active': True}, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='ingredients', to='recipes.ingredientcategory', verbose_name='ì¹´í…Œê³ ë¦¬'),
        ),
        migrations.AlterField(
            model_name='normalizedingredient',
            name='category',
            field=models.ForeignKey(blank=True, help_text='ì¬ë£Œ ë¶„ë¥˜', limit_choices_to={'category_type': 'normalized', 'is_active': True}, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='normalized_ingredients', to='recipes.ingredientcategory', verbose_name='ì¹´í…Œê³ ë¦¬'),
        ),
    ]
